<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShutterWorx - Membership Sign-Up</title>
    <meta name="description" content="Sign up for ShutterWorx - Choose from Basic, Pro, or Elite membership plans designed for photographers.">
    <meta name="keywords" content="ShutterWorx, Photography Membership, Pro Membership, Elite Membership, Online Photo Sales, SEO Optimization, Event Management">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="ShutterWorx - Membership Sign-Up">
    <meta property="og:description" content="Join ShutterWorx to grow your photography business with powerful tools and exclusive features.">
    <meta property="og:image" content="URL_TO_IMAGE">
    <meta name="twitter:card" content="summary_large_image">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>

 <!-- Header -->
 <header id="site-header">
    <h1 id="header-title">Join ShutterWorx</h1>
    <p id="header-subtitle">Your gateway to exclusive photography services and community!</p>
    <nav id="nav-menu">
        <ul>
            <li><a href="./ShutterWorx">Home</a></li>
            <li><a href="shutterWorx/join">Join Now</a></li>
            <li><a href="shutterWorx/FAQ">FAQ</a></li>
            <li><a href="shutterWorx/contact">Contact</a></li>
        </ul>
    </nav>
</header>

    <!-- Header -->
    <header class="header text-center py-5" style="background-color: #007bff; color: white;">
        <h1>Join ShutterWorx Membership</h1>
        <p>Choose the perfect plan to grow your photography business.</p>
    </header>
<main>
    <!-- Membership Information -->
    <section class="container my-5">
        <div class="membership-card text-center shadow p-4 rounded">
            <h3 id="membership-header" class="pricing-header"></h3>
            <p id="membership-price" class="membership-price"></p>
            <p id="membership-yearly-price" class="membership-price"></p>
            <ul id="features-list" class="list-unstyled features-list mb-4"></ul>
        </div>
    </section>

    <!-- Login Information -->
    <section class="container my-5">
        <h3>Sign-Up or Log In</h3>
        <form id="signup-form" action="/process-signup" method="POST">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>

            <!-- Stripe Payment Info -->
            <div class="form-group">
                <label for="card-element">Payment Information</label>
                <div id="card-element" class="form-control">
                    <!-- Stripe Card Element will go here -->
                </div>
                <div id="card-errors" role="alert"></div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg">Join Now</button>
        </form>

        <!-- Google Sign-Up Button -->
        <button id="googleSignupBtn" class="btn btn-danger btn-lg mt-4">
            <i class="fab fa-google"></i> Sign Up with Google
        </button>

        <!-- Phone Sign-Up -->
        <div class="form-group mt-4">
            <label for="phone">Phone Number</label>
            <input type="tel" class="form-control" id="phone" name="phone" placeholder="+1 234 567 8901" required>
        </div>
        <button id="phoneSignupBtn" class="btn btn-info btn-lg mt-4">
            <i class="fas fa-phone"></i> Sign Up with Phone
        </button>
    </section>
</main>


    <!-- Footer -->
    <footer id="site-footer">
        <div class="social-icons">
            <!-- Social media links dynamically added here -->
        </div>
        <footer-body>
            <p>&copy; 2024 <a href="./shutterWorx/" style="color: #fff;">ShutterWorx</a>/ TechNoob All Rights Reserved.</p>
            <p><small><a href="privacy" style="color: #fff;">Privacy Policy</a> | <a href="terms" style="color: #fff;">Terms of Service</a></small></p>
        </footer-body>
    </footer>

   <!-- Stripe.js -->
   <script src="https://js.stripe.com/v3/"></script>
   <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"></script>


   <script>
   
   </script>
   
   <!-- HTML Structure for displaying membership details and Stripe card element -->
   <div id="membership-header"></div>
   <div id="membership-price"></div>
   <div id="membership-yearly-price"></div>
   
   <ul id="features-list"></ul>
   
   <form id="payment-form">
       <div id="card-element"></div>
       <div id="card-errors" role="alert"></div>
       <button type="submit">Subscribe Now</button>
   </form>
   
<!-- Modal Structure for Success Message -->
<div id="success-message" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Thank you for subscribing! Your payment was successful.</h3>
        <button onclick="window.location.href = '/admin/dashboard';">Proceed to Dashboard</button>
    </div>
</div>

<script  type="module" src="./js/firebaseConfig.js"></script>

<script  type="module" src="./js/main.js"></script>
      

<script  type="module" src="./js/admin.js"></script>


<!-- Include your firebaseConfig.js as a module -->
<script  type="module" src="./js/firebaseConfig.js"></script>
    <script type="module">
        import { 
            db, 
            doc, 
            getDoc, 
            query, 
            updateDoc, 
            setDoc,     
            signInWithPopup, 
            GoogleAuthProvider, 
            FacebookAuthProvider, 
            OAuthProvider,
            signOut, 
            addDoc, 
            increment, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            where, 
            getDocs, 
            storage, 
            collection, 
            auth, 
            analytics 
        } from './js/firebaseConfig.js';


        let viewStartTime;

// Function to set the last internal page in sessionStorage before navigating
function setInternalPageSource() {
    sessionStorage.setItem('lastInternalPage', window.location.href);
}

// Function to start tracking the view time when the page loads
function startViewTimer() {
    viewStartTime = Date.now();
    //console.log("viewStartTime   ",viewStartTime);

}



    // Determine the source
    const externalSource = document.referrer && !document.referrer.includes(window.location.origin)
        ? document.referrer
        : null;
    const internalSource = sessionStorage.getItem('lastInternalPage');
    const viewSource = externalSource || internalSource || 'Direct Visit';



    let ipAddress;
let locationData;

document.addEventListener("DOMContentLoaded", async () => {
    try {
        const { ip, location } = await window.userLocationService.getUserIPAndLocation();

        ipAddress = ip;
        locationData = location;
    } catch (error) {
        console.error("Error fetching user IP and location:", error);
    }
});


// Membership plans data
const membershipPlans = {
       basic: {
           name: "Basic Membership",
           price: "$29/month",
           yearlyPrice: "$290/year",
           features: [
               "Standard features",
               "Standard watermark for photos",
               "Customizable Pages (Home, Events, Portfolio, Contact)",
               "SEO features to optimize visibility",
               "Sell photos online (Powered by Stripe)",
               "Transaction logs for tracking sales",
               "Access code for private events",
               "5 events allowed per month",
               "20 images per event",
               "Limited customer support"
           ],
           stripePriceId: 'price_basic_id'  // Replace with actual Stripe price ID
       },
       pro: {
           name: "Pro Membership",
           price: "$49/month",
           yearlyPrice: "$490/year",
           features: [
               "All Basic Membership features",
               "Customizable watermark for photos",
               "Built-in photo editor for quick edits",
               "QR code generator for easy event sharing",
               "Help Bot for instant support",
               "20 events allowed per month",
               "50 images per event",
               "Priority customer support",
               "Exclusive content and features"
           ],
           stripePriceId: 'price_pro_id'  // Replace with actual Stripe price ID
       },
       elite: {
           name: "Elite Membership",
           price: "$99/month",
           yearlyPrice: "$990/year",
           features: [
               "All Basic & Pro Membership features",
               "Add unlimited additional pages to your site",
               "Advanced event management tools",
               "Social media plugins for easy sharing",
               "Premium analytics for in-depth performance insights",
               "Add multiple users to your account",
               "Custom domain setup (coming soon)",
               "Unlimited events and unlimited photo uploads",
               "24/7 customer support",
               "Personalized coaching sessions for growth"
           ],
           stripePriceId: 'price_elite_id'  // Replace with actual Stripe price ID
       }
   };
   
   // Initialize Stripe and Stripe Elements
   const stripe = Stripe("YOUR_PUBLIC_STRIPE_KEY"); // Replace with your actual Stripe public key
   const elements = stripe.elements();
   const cardElement = elements.create('card');

   // Display membership details based on URL
   function loadMembershipDetails() {
       const url = window.location.href;
       const membershipType = url.split('-')[1] || 'basic'; // Assuming the plan type is in the URL
       const plan = membershipPlans[membershipType];
   
       // Populate the membership details
       document.getElementById('membership-header').innerText = plan.name;
       document.getElementById('membership-price').innerText = `Monthly: ${plan.price}`;
       document.getElementById('membership-yearly-price').innerText = `Yearly: ${plan.yearlyPrice}`;
       const featuresList = document.getElementById('features-list');
       featuresList.innerHTML = plan.features.map(feature => `<li>${feature}</li>`).join('');
       
       // Mount the Stripe card element for payment
       cardElement.mount('#card-element');
       
       // Handle form submission to create payment
       const form = document.getElementById('payment-form');
       form.addEventListener('submit', async (event) => {
           event.preventDefault();
           
           // Create a Stripe payment method
           const { token, error } = await stripe.createToken(cardElement);
           
           if (error) {
               // Display error message
               document.getElementById('card-errors').textContent = error.message;
           } else {

               // Example of sending the token to the backend for processing
               try {
                  // Send token to your backend to process the payment
               
                  handleAuth(uid, loginMethod, membershipType, token.id, membershipExpire, plan.stripePriceId);
            // Save email to localStorage
            localStorage.setItem('admin-Email', userData.email);
            localStorage.setItem('loggedIn', true);

   
               } catch (error) {
                   console.error('Error processing payment:', error);
                   alert('There was an error processing your payment. Please try again.');
               }
           }
       });
   }
   
   // Initialize the page
   loadMembershipDetails();







// Update or add user to Firebase Firestore
function updateUserCollection(uid, data) {
    const userRef = doc(db, 'Members', uid);
    setDoc(userRef, data, { merge: true })
        .then(() => console.log("User added/updated in Firestore"))
        .catch(error => showError(`Firestore Error: ${error.message}`));
}

// Authentication handler
function handleAuth(uid,loginMethod,membershipType, token, membershipExpire, stripePriceId) {
    window.showLoadingSpinner(false);

    authMethod()
        .then(userCredential => {
            const user = userCredential.user;
            const userData = {
                userID: uid || '',
                email: user.email || '',
                phone: user.phoneNumber || '',
                displayName: user.displayName,
                lastLogin: new Date(),
                createdAt: new Date(),
                loginDevice: navigator.userAgentData?.mobile ? "mobile" : "desktop",
                loginMethod: loginMethod,
                membershipType: membershipType,
                membershipExpire: membershipExpire,
                paymentStatus: "paid",
                priceId: stripePriceId,
                status: "active",
                stripeToken: token,
                authMethod: authMethod,
                ipAddress: ipAddress,
        city: locationData.city,
        zipCode: locationData.zip,
        state: locationData.state,
        country: locationData.country,
        loginCount: increment(1)
            };

            updateUserCollection(user.uid, userData);
            showToast("Logged in successfully!", "success");

            
            // After successful payment, display the modal and then redirect after 5 seconds
setTimeout(function() {
    window.location.href = '/admin/dashboard';
}, 5000);  // 5000 milliseconds = 5 seconds

        })
        .catch(error => showToast(error.message, "error",5000))
        .finally(() => window.hideLoadingSpinner());
}






// Handle Google Sign-Up/Login
document.getElementById('googleSignupBtn').addEventListener('click', async function () {
    const provider = new GoogleAuthProvider();
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        if (await checkPaymentStatus(user.uid, "Google")) {
            alert('Google Sign-In Successful!');
            // Proceed to save user info or navigate
        }
    } catch (error) {
        console.error(error.message);
        alert('Error during Google sign-in.');
    }
});

// Phone Sign-Up
document.getElementById('phoneSignupBtn').addEventListener('click', async function () {
    const phoneNumber = document.getElementById('phone').value;
    const appVerifier = new firebase.auth.RecaptchaVerifier('phoneSignupBtn', { size: 'invisible' }, auth);

    try {
        const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
        const verificationCode = prompt('Enter the code sent to your phone:');
        const userCredential = await confirmationResult.confirm(verificationCode);
        const user = userCredential.user;

        if (await checkPaymentStatus(user.uid, "Phone")) {
            alert('Phone Sign-In Successful!');
            // Proceed to save user info or navigate
        }
    } catch (error) {
        console.error(error.message);
        alert('Phone sign-in failed.');
    }
});

// Email Sign-Up
document.getElementById('emailSignupBtn').addEventListener('click', async function () {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        if (await checkPaymentStatus(user.uid, "Email")) {
            alert('Email Sign-Up Successful!');
            // Proceed to save user info or navigate
        } else {
            alert('Please complete your payment first.');
        }
    } catch (error) {
        console.error(error.message);
        alert('Error during email sign-up.');
    }
});

// Event listener for form submission (email/password sign-up)
const form = document.getElementById('signup-form');
form.addEventListener('submit', async (event) => {
    event.preventDefault();

    // Show loading spinner
    showLoadingSpinner(true);

    // Create Stripe token
    const { token, error } = await stripe.createToken(cardElement);

    if (error) {
        // Display error message
        document.getElementById('card-errors').textContent = error.message;
        showLoadingSpinner(false);
    } else {
        try {
            // Token was created successfully, proceed to create the account
            const hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripeToken');
            hiddenInput.setAttribute('value', token.id);
            form.appendChild(hiddenInput);

            // Get email and password
            const email = form.querySelector('input[name="email"]').value;
            const password = form.querySelector('input[name="password"]').value;

            // Check if the account already exists
            const accountExists = await checkIfAccountExists(email);

            if (accountExists) {
                // If account exists, show a message and don't submit form
                document.getElementById('account-error').textContent = 'An account already exists with this email.';
                showLoadingSpinner(false);
            } else {
                // Proceed to create the account
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Check payment status
                if (await checkPaymentStatus(user.uid, "Email")) {
                    // Proceed to save user info or navigate
                    form.submit(); // Submit form for further processing
                } else {
                    alert('You need to complete your payment first.');
                    showLoadingSpinner(false);
                }
            }
        } catch (err) {
            console.error('Error during account creation check:', err);
            document.getElementById('account-error').textContent = 'Something went wrong. Please try again later.';
            showLoadingSpinner(false);
        }
    }
});



const paymentForm = document.getElementById("payment-form");

paymentForm.addEventListener("submit", async (event) => {
    event.preventDefault();

    const { token, error } = await stripe.createToken(cardElement);
    if (error) {
        document.getElementById("card-errors").textContent = error.message;
    } else {
        fetch("/process-payment", {
            method: "POST",
            body: JSON.stringify({ token: token.id }),
            headers: { "Content-Type": "application/json" },
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Show success message modal
                  document.getElementById("success-message").style.display = "block";
              } else {
                  document.getElementById("card-errors").textContent = "Payment failed!";
              }
          });
    }
});







    

 function updateViewData() {
    // Calculate view duration in seconds
    const viewEndTime = Date.now();
    const durationOfView = (viewEndTime - viewStartTime) / 1000; // Convert ms to seconds

    // Validate IP address before proceeding
    if (!ipAddress) {
        console.error("Missing IP address. View data not recorded.");
        return;
    }


    // Prepare the data to be updated
    const viewData = {
        SigningUpViewedBy: {
            viewDate: new Date().toISOString(),
            viewMethod: navigator.userAgentData?.mobile ? "mobile" : "desktop",
            durationOfView: (Date.now() - viewStartTime) / 1000,
            viewSource: viewSource
        },
        ipAddress: ipAddress,
        city: locationData.city,
        zipCode: locationData.zip,
        state: locationData.state,
        country: locationData.country,
        contactViews: increment(1)
    };

    console.log("viewData   ",viewData);

    // Update or create the job view data in the Jobs collection
    setDoc(doc(db, 'guest-ShutterWorx', ipAddress), viewData, { merge: true });
      //  console.log("Job view data updated successfully.");
 
}


// Event listener to set last internal page before navigating away
window.addEventListener('beforeunload', setInternalPageSource);

// Event listener to start timing the view when the page loads
window.addEventListener('load', startViewTimer);

// Event listener to record data when the page is unloaded
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        updateViewData();
    }
});

     
  
/*
setTimeout(() => {
    updateViewData();
}, 5000); // Close modal after 5 seconds
*/

</script>

</body>
</html>

